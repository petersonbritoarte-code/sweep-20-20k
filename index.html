<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Freq 20/20 — Varredura de Frequências</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Freq 20/20">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{ color-scheme: dark; --accent:#8bd3ff; }
  *{ box-sizing:border-box; }

  body{
    margin:0;
    background:#000;
    min-height:100svh;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding: calc(14px + env(safe-area-inset-top)) 14px calc(14px + env(safe-area-inset-bottom));
  }

  .stage{
    width:min(980px, 100%);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
  }

  .center{
    width:100%;
    text-align:center;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }

  #brandTop{
    font-size: 18px;
    font-weight: 900;
    color:#fff;
    opacity:.95;
    letter-spacing:.4px;
    margin-top:2px;
  }

  #bandLabel{
    font-size:18px;
    font-weight:900;
    letter-spacing:.7px;
    text-transform:uppercase;
    color:var(--accent);
  }

  #freq{
    font-family:ui-monospace,Menlo,Consolas,monospace;
    font-size:clamp(72px,12vw,140px);
    font-weight:950;
    color:var(--accent);
    line-height:1;
    text-shadow: 0 0 18px rgba(255,255,255,.06);
  }

  #bandTip{
    max-width:900px;
    font-size:16px;
    color:#b8bcc1;
    line-height:1.45;
    min-height:2.6em;
    padding:0 8px;
  }

  .safety{
    width:100%;
    max-width:920px;
    margin-top:4px;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid #2a1f00;
    background:#0f0c00;
    color:#e8eaed;
    font-size:14px;
    line-height:1.4;
  }
  .safety strong{ color:#ffd36a; }

  .controls{
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
    margin-top:4px;
  }

  .rowBtns{
    display:flex;
    gap:14px;
    justify-content:center;
    flex-wrap:wrap;
  }

  button{
    appearance:none;
    border:1px solid #2b2b2b;
    background:#111;
    color:#e8eaed;
    padding:14px 22px;
    border-radius:18px;
    font-weight:900;
    cursor:pointer;
    font-size:16px;
  }
  button:hover{ background:#151515; }
  button:disabled{ opacity:.5; cursor:not-allowed; }

  .box{
    width:100%;
    max-width:860px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
    padding:12px 14px;
    border:1px solid #1f1f1f;
    background: rgba(10,10,10,.75);
    backdrop-filter: blur(6px);
    border-radius:16px;
    color:#c9cdd1;
    font-size:14px;
  }

  input[type="range"]{
    width: 340px;
    touch-action: pan-y;
  }

  .mono{
    font-family:ui-monospace,Menlo,Consolas,monospace;
    color:#e8eaed;
    font-weight:900;
  }

  /* Painel de infos (fica abaixo da posição) */
  .infoPanel{
    width:100%;
    max-width:860px;
    display:flex;
    flex-direction:column;
    gap:10px;
    padding:12px 14px;
    border:1px solid #1f1f1f;
    background: rgba(10,10,10,.65);
    backdrop-filter: blur(6px);
    border-radius:16px;
    color:#c9cdd1;
    margin-top:2px;
  }

  .infoRow{
    display:flex;
    justify-content:center;
    flex-wrap:wrap;
    gap:10px 14px;
    font-size:13px;
  }

  .chip{
    display:flex;
    gap:8px;
    align-items:center;
    padding:8px 10px;
    border:1px solid #1f1f1f;
    border-radius:14px;
    background: rgba(0,0,0,.25);
  }

  .dot{
    width:10px;height:10px;border-radius:50%;
    background:var(--accent);
    box-shadow: 0 0 14px rgba(255,255,255,.08);
  }

  @media (max-width: 720px){
    #brandTop{ font-size:16px; }
    #bandLabel{ font-size:15px; }
    #bandTip{ font-size:14px; }
    .safety{ font-size:13px; }
    input[type="range"]{ width:min(260px, 78vw); }
    #freq{ font-size:clamp(56px,16vw,92px); }
  }
</style>
</head>

<body>
  <div class="stage">

    <div class="center">
      <div id="brandTop">youtube.com/@ProfPetersonBrito</div>

      <div id="bandLabel">SUBGRAVE (20–40 Hz)</div>
      <div id="freq">20 Hz</div>
      <div id="bandTip">Sensação física e “peso”. Mais sentido no corpo do que no ouvido.</div>

      <div class="safety">
        <strong>Segurança:</strong>
        Comece com volume baixo. Sweeps (Varreduras) podem ficar agressivos em 2–5 kHz.
        Evite fones no máximo, faça pausas e interrompa ao menor sinal de desconforto.
        O “dBFS” exibido é ganho digital (não é SPL no ouvido). O volume real depende também de seu equipamento e ajustes pessoais.
      </div>
    </div>

    <div class="controls">
      <div class="rowBtns">
        <button id="startBtn">Iniciar</button>
        <button id="stopBtn" disabled>Parar</button>
      </div>

      <div class="box">
        <span>Volume</span>
        <input id="vol" type="range" min="0" max="1" step="0.001" value="0.08">
        <b id="volLabel" class="mono">8%</b>
      </div>

      <div class="box">
        <span>Posição</span>
        <input id="seek" type="range" min="0" max="300" step="0.01" value="0">
        <b id="seekLabel" class="mono">00:00 / 05:00</b>
        <span style="color:#9aa0a6;">•</span>
        <span>Prog.</span>
        <b id="progInfo" class="mono">0%</b>
      </div>

      <!-- Infos técnicas abaixo (sem sobrepor nada) -->
      <div class="infoPanel">
        <div class="infoRow">
          <div class="chip"><span class="dot"></span><span>Sweep</span><b class="mono">20 → 20.000 Hz</b></div>
          <div class="chip"><span>Curva</span><b class="mono">LOG</b></div>
        </div>
        <div class="infoRow">
          <div class="chip"><span>Sample rate</span><b id="srInfo" class="mono">—</b></div>
          <div class="chip"><span>Ganho</span><b id="gainInfo" class="mono">—</b></div>
        </div>
      </div>
    </div>

  </div>

<script>
(() => {
  const BANDS = [
    { n:"Subgrave",    min:20,   max:40,      c:"#8bd3ff", t:"Sensação física e “peso”. Mais sentido no corpo do que no ouvido." },
    { n:"Grave-Baixo", min:40,   max:80,      c:"#66e0ff", t:"Fundação do grave. Base rítmica e sustentação do low-end." },
    { n:"Grave-Alto",  min:80,   max:200,     c:"#4ff2d6", t:"Punch e impacto. Excesso aqui costuma embolar/mascarar." },
    { n:"Médio-Grave", min:200,  max:500,     c:"#72ff7a", t:"Corpo e ressonância (“boxy”). Pode soar abafado se exagerar." },
    { n:"Médio-Médio", min:500,  max:1500,    c:"#cfff6a", t:"Centro do timbre. Dá “leitura”, mas pode ficar nasal/duro." },
    { n:"Médio-Agudo", min:1500, max:5000,    c:"#ffe66a", t:"Presença e inteligibilidade. Região sensível do ouvido: cuidado." },
    { n:"Agudo",       min:5000, max:12000,   c:"#ffb86a", t:"Brilho e ataque. Pode evidenciar sibilância/aspereza." },
    { n:"Super-Agudo", min:12000,max:20000.1, c:"#ff4d4d", t:"“Ar” e cintilância. Fácil causar fadiga em volumes altos." }
  ];

  const fStart = 20, fEnd = 20000, duration = 300;

  // UI
  const freqEl = document.getElementById("freq");
  const bandEl = document.getElementById("bandLabel");
  const tipEl  = document.getElementById("bandTip");

  const startBtn = document.getElementById("startBtn");
  const stopBtn  = document.getElementById("stopBtn");

  const vol = document.getElementById("vol");
  const volLabel = document.getElementById("volLabel");

  const seek = document.getElementById("seek");
  const seekLabel = document.getElementById("seekLabel");
  const progInfo = document.getElementById("progInfo");

  const srInfo   = document.getElementById("srInfo");
  const gainInfo = document.getElementById("gainInfo");

  // WebAudio
  let ctx = null, osc = null, gain = null;
  let raf = null;
  let tStart = 0, tEnd = 0;

  // State
  let offsetSec = 0;
  let isRunning = false;
  let isUserDrag = false;
  let lastBand = -1;

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtTime(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec/60), s = sec%60;
    return `${pad2(m)}:${pad2(s)}`;
  }
  function fmtHz(f){ return Math.round(f).toLocaleString("pt-BR") + " Hz"; }
  function gainToDbfs(g){
    const x = Math.max(0.000001, g);
    return 20 * Math.log10(x);
  }

  function freqAt(t){
    const p = Math.min(Math.max(t / duration, 0), 1);
    return fStart * Math.pow(fEnd/fStart, p);
  }

  function bandIndexFor(f){
    for (let i=0;i<BANDS.length;i++){
      const b=BANDS[i];
      if (f>=b.min && f<b.max) return i;
    }
    return BANDS.length-1;
  }

  function applyBand(i){
    const b = BANDS[i];
    const maxShown = (b.max>20000) ? "20.000" : String(Math.round(b.max));
    bandEl.textContent = `${b.n.toUpperCase()} (${b.min}–${maxShown} Hz)`;
    tipEl.textContent = b.t;
    document.documentElement.style.setProperty("--accent", b.c);
  }

  function updateSeekUI(t){
    const p = Math.min(Math.max(t / duration, 0), 1);
    seekLabel.textContent = `${fmtTime(t)} / ${fmtTime(duration)}`;
    progInfo.textContent = `${Math.round(p*100)}%`;
  }

  function previewAt(t){
    const f = freqAt(t);
    freqEl.textContent = fmtHz(f);
    const bi = bandIndexFor(f);
    applyBand(bi);
    lastBand = bi;
    updateSeekUI(t);
  }

  function setRunning(r){
    isRunning = r;
    startBtn.disabled = r;
    stopBtn.disabled  = !r;
  }

  function ensureCtx(){
    if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
    return ctx;
  }

  // iOS-safe: NÃO usar await na cadeia do clique; usar .then()
  function resumeCtxThen(cb){
    ensureCtx();

    const doUnlock = () => {
      try{
        // "ping" curtíssimo (destrava áudio no Safari em alguns casos)
        const buffer = ctx.createBuffer(1, 1, ctx.sampleRate);
        const src = ctx.createBufferSource();
        src.buffer = buffer;
        src.connect(ctx.destination);
        src.start(0);
        src.stop(0.01);
      }catch(e){}
    };

    if (ctx.state === "suspended") {
      ctx.resume().then(() => { doUnlock(); cb(); }).catch(() => { cb(); });
    } else {
      doUnlock(); cb();
    }
  }

  function stopOscOnly(){
    if (!ctx || !osc) return;
    const now = ctx.currentTime;

    if (gain){
      gain.gain.cancelScheduledValues(now);
      gain.gain.setValueAtTime(gain.gain.value, now);
      gain.gain.linearRampToValueAtTime(0.00001, now + 0.03);
    }
    try { osc.stop(now + 0.04); } catch(e){}
    osc = null;
  }

  function startInternal(newOffset){
    // Para só o oscilador (mantém ctx vivo -> melhor no iOS)
    if (osc) stopOscOnly();

    offsetSec = Math.min(Math.max(newOffset, 0), duration);
    seek.value = String(offsetSec);

    if (offsetSec >= duration) {
      previewAt(duration);
      setRunning(false);
      return;
    }

    osc = ctx.createOscillator();
    gain = ctx.createGain();
    osc.type = "sine";

    const g0 = Math.max(0.00001, Number(vol.value));
    gain.gain.value = g0;

    osc.connect(gain);
    gain.connect(ctx.destination);

    const now = ctx.currentTime;
    tStart = now + 0.05;
    const remaining = duration - offsetSec;
    tEnd = tStart + remaining;

    const f0 = freqAt(offsetSec);
    osc.frequency.setValueAtTime(f0, tStart);
    osc.frequency.exponentialRampToValueAtTime(fEnd, tEnd);

    srInfo.textContent = `${Math.round(ctx.sampleRate)} Hz`;
    gainInfo.textContent = `${g0.toFixed(3)} (≈ ${gainToDbfs(g0).toFixed(1)} dBFS)`;

    previewAt(offsetSec);

    osc.start(tStart);
    osc.stop(tEnd);

    setRunning(true);

    if (raf) cancelAnimationFrame(raf);
    raf = requestAnimationFrame(loop);
  }

  function loop(){
    if (!ctx || !osc) return;

    const now = ctx.currentTime;
    const t = offsetSec + (now - tStart);

    const f = freqAt(t);
    freqEl.textContent = fmtHz(f);

    const bi = bandIndexFor(f);
    if (bi !== lastBand){
      applyBand(bi);
      lastBand = bi;
    }

    if (!isUserDrag){
      const clamped = Math.min(Math.max(t, 0), duration);
      seek.value = String(clamped);
      updateSeekUI(clamped);
    }

    const g = gain ? gain.gain.value : Number(vol.value);
    gainInfo.textContent = `${g.toFixed(3)} (≈ ${gainToDbfs(g).toFixed(1)} dBFS)`;

    if (now < tEnd) {
      raf = requestAnimationFrame(loop);
    } else {
      offsetSec = duration;
      setRunning(false);
      stopOscOnly();
      previewAt(offsetSec);
    }
  }

  // Volume
  vol.addEventListener("input", () => {
    const v = Number(vol.value);
    volLabel.textContent = Math.round(v*100) + "%";
    gainInfo.textContent = `${v.toFixed(3)} (≈ ${gainToDbfs(v).toFixed(1)} dBFS)`;
    if (gain && ctx){
      const now = ctx.currentTime;
      gain.gain.setTargetAtTime(Math.max(0.00001, v), now, 0.02);
    }
  });

  // Seek
  seek.addEventListener("input", () => {
    offsetSec = Number(seek.value);
    if (!isRunning) previewAt(offsetSec);
    else updateSeekUI(offsetSec);
  });

  // Mobile drag
  seek.addEventListener("touchstart", () => { isUserDrag = true; }, {passive:true});
  seek.addEventListener("touchend", () => {
    isUserDrag = false;
    if (isRunning) {
      // garantir gesto iOS: faz resume + start dentro do mesmo fluxo do touchend
      resumeCtxThen(() => startInternal(Number(seek.value)));
    }
  }, {passive:true});

  // iOS às vezes só dispara change confiável
  seek.addEventListener("change", () => {
    offsetSec = Number(seek.value);
    if (isRunning) resumeCtxThen(() => startInternal(offsetSec));
    else previewAt(offsetSec);
  });

  // Desktop mouse
  seek.addEventListener("mousedown", () => { isUserDrag = true; });
  window.addEventListener("mouseup", () => {
    if (!isUserDrag) return;
    isUserDrag = false;
    if (isRunning) resumeCtxThen(() => startInternal(Number(seek.value)));
  });

  // Botões
  startBtn.addEventListener("click", () => {
    resumeCtxThen(() => startInternal(Number(seek.value)));
  });

  stopBtn.addEventListener("click", () => {
    if (raf) cancelAnimationFrame(raf);
    raf = null;

    stopOscOnly();

    offsetSec = Number(seek.value);
    setRunning(false);
    srInfo.textContent = "—";
    previewAt(offsetSec);

    // Mantém ctx aberto (melhor para iOS). Se quiser fechar, descomente:
    // if (ctx){ try{ ctx.close(); }catch(e){} ctx=null; }
  });

  // Init
  const gInit = Number(vol.value);
  volLabel.textContent = Math.round(gInit*100) + "%";
  gainInfo.textContent = `${gInit.toFixed(3)} (≈ ${gainToDbfs(gInit).toFixed(1)} dBFS)`;

  seek.max = String(duration);
  seek.value = "0";
  offsetSec = 0;

  previewAt(0);
  setRunning(false);
})();
</script>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js").catch(() => {});
    });
  }
</script>
</body>
</html>
